# 登录设计

现代系统的登录方式有很多，如密码登录、手机验证码登录、动态令牌登录、语音验证码登录、本机号码一键登录等。每种登录方式都有自己的特点，都采用不同的设计方式，并且设计Session会话、Token令牌、OAuth2.0、JWT等众多技术。单体架构，集群架构、微服务架构在登录设计上又有不同的方法。

登录功能看似简单，实则要考虑很多问题。

## 登录功能的重要性

主要有以下四个方面的原因。

1. 一旦登录功能不可用，将会直接带来巨大的经济损失。
2. 登录是有权限累操作的大门，必须经过他的验证。
3. 登录承载的压力巨大，他是系统的第一步。
4. 登录是一个系统的脸面。

## 登录功能设计需要考虑哪些方面？

随着网络和软件系统的发展，我们需要考虑到的东西主要是这几个方面：

1. 存储方式：数据存储在哪里？如何组织？
2. 交互方式：如何和数据进行交互？采用什么样的传输协议？
3. 登录方式：登录的方式是什么？不同的方式有不同的设计。
4. 校验方式：怎么样定义登录成功、异常还是失败？
5. 安全设计：怎么样方式攻击，保证登录可靠性？
6. 衍生需求：由登录功能产生出的扩展需求。

## 多类型账密登录设计

账号和密码登录的形式主要有以下几种：

1. 账号和密码
2. 邮箱和密码
3. 手机号和密码

为了方面用户的使用，我们一般在登录时输入以上的账号类型，然后由系统自动判断账号的类型。

#### 判断账号类型 方案1：服务端匹配

此种方案下客户端向服务端发送用户名和密码两个字段。有服务器进行判断账号的类型。

![image-20230308185524836](https://nanak-img.oss-cn-beijing.aliyuncs.com/img/image-20230308185524836.png)

数据库用户表采用横向设计，将账号、手机号、邮箱分别存储在同一个表的不同字段中。如下表

|   字段    |        主键        |
| :-------: | :----------------: |
| username  |      用户姓名      |
| accountno |  用户账号（唯一）  |
|  mobile   | 用户手机号（唯一） |
|   email   |  用户邮箱（唯一）  |
| password  |      用户密码      |

服务器采用or语句进行匹配，SQL如下：

`select * from t_user where (accountno=#{username} or accountno=#{mobile} or accountno=#email) and password=#{password}`

优点是无需知道用户采用哪种方式登录，统一由后端匹配。

缺点是多个or语句会导致SQL的执行性能急剧下降，如果系统内存在大量的用户，则会导致查询非常缓慢。

#### 方案二：客户端匹配设计

此种方案下客户端需要多发送一个登录方式的字段。例如Type=1（账号的类型）。由客户端根据正则表达式匹配用户提交的账号的类型。

![image-20230308190318741](https://nanak-img.oss-cn-beijing.aliyuncs.com/img/image-20230308190318741.png)

前端需要先进行账号类型的匹配然后把类型发送给后端。

后端接受到前端发发送过来的请求，进行认证。SQL如下

```sql
select * from t_user where account=#{username} and password=#{password}
select * from t_user where mobile=#{mobile} and password=#{password}
select * from t_user where email=#{email} and password=#{password}
```

看似很小的改动，却可以带来性能的成倍增长，数据量越大，提升的效果越明显。

注意：对于以上两种设计方案，在账号、手机号、邮箱字段上一定要增加独立索引或复合索引来提高查询效率。

## 三类验证码登录设计

常用的验证码登录方式有三种，分别是手机号验证码登录、动态令牌登录和语音验证码登录。虽然说邮箱登录也可以，但是还是比较麻烦。

不同的验证码登录技术有不同的实现技术，手机验证码涉及短信发送技术，动态令牌涉及动态秘钥的计算技术，语音验证码登录涉及TTS（Text to speech，文本转语音）技术。

## Cookie、Session、Token和JWT

### Cookie

Cookie的核心功能是存储一些文本信息，浏览器发送请求的过程中会携带Cookie发送给服务器，服务器可以检索这些功能实现一些功能，比如识别是不是同一个用户（浏览器）正在访问服务。

Cookie的使用：https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies

### Session

Session在网络应用中称为“会话控制”，是服务器为了保存用户状态而创建的一个特殊的对象。简而言之，session就是一个对象，用于存储信息。 

简单说Session就是基于某些服务器和客户端都储存的一个唯一值关联起来的。cookie只是实现方式的一种，cookie中储存一个唯一ID，服务器储存这个唯一ID关联的数据。这就是session。这个表示一般是

Session是每一个游览器(客户端)所唯一的，这个是怎么实现的呢？其实，在访问一个网站时，在HTTP请求中往往会携带一个cookie，这个cookie的名字是JSESSIONID，这个JSESSIONID表示的就是session的id，这个是由服务器创建的，并且是唯一的。服务器在使用session时，会根据JSESSIONID来进行不同操作。

### Token
Token是一种身份验证机制，用于验证用户的身份和权限。在Web应用程序中，当用户进行身份验证后，服务器会生成一个Token并返回给客户端。客户端在后续的请求中携带该Token，服务器通过验证Token来确认用户的身份和权限。

Token通常是一个长字符串，可以是基于加密算法生成的，包含了用户的身份信息和其他相关数据。客户端在每次请求中将Token放在请求头或请求参数中，服务器通过验证Token的有效性来授权用户的访问。

Token的优点是无状态，服务器不需要在每个请求中保存用户的会话信息，可以减轻服务器的负担，并支持跨域访问。

### JWT（JSON Web Token）
JWT是一种基于Token的身份验证机制，使用JSON格式将用户的身份信息进行编码和解码。JWT由三部分组成：头部（Header）、载荷（Payload）和签名（Signature）。

头部包含了算法类型和令牌类型等信息，载荷包含了用户的身份信息和其他相关数据，签名用于验证Token的完整性和真实性。

JWT的生成和验证过程是在客户端和服务器之间进行的，服务器生成JWT并返回给客户端，客户端将JWT存储在本地，并在后续的请求中携带JWT。服务器通过验证JWT的签名和有效期来确认用户的身份和权限。

JWT具有可扩展性和自包含性的特点，可以在Token中包含自定义的信息，并且不需要在服务器端存储会话信息。

